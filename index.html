<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vending Machine Display</title>

  <!-- QR Code library (ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase config (Ù…Ø«Ù„ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ)
    const firebaseConfig = {
      apiKey: "AIzaSyBzKF_fuEKbSP-8JuBZb9QkuMj9eGcBsYw",
      authDomain: "advanced-vending-machine.firebaseapp.com",
      databaseURL: "https://advanced-vending-machine-default-rtdb.firebaseio.com",
      projectId: "advanced-vending-machine",
      storageBucket: "advanced-vending-machine.firebasestorage.app",
      messagingSenderId: "119768375164",
      appId: "1:119768375164:web:d96d14021f495869474ef9"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù€ database Ø¯Ø§Ø®Ù„ window Ø­ØªÙ‰ ØªÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª
    window.MACHINE_DB = database;
    window.DB_ref = ref;
    window.DB_onValue = onValue;
    window.DB_set = set;
  </script>

  <style>
    /* (Ù†Ø³Ù‚ Ø¨Ø³ÙŠØ· - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø£Ù†ÙŠÙ‚Ø©) */
    body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg,#0a0e27,#1a1a3e); color: #fff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
    .machine-screen { width:90%; max-width:760px; background:linear-gradient(135deg,#1e1e3f,#2d2d5f); border-radius:20px; padding:24px; box-shadow:0 15px 40px rgba(0,0,0,.6); border:5px solid #6366f1; }
    .machine-title { font-size:28px; font-weight:900; text-align:center; margin-bottom:12px; background:linear-gradient(90deg,#6366f1,#ec4899); -webkit-background-clip:text; color:transparent; }
    .display-area { background:#0a0b14; padding:18px; border-radius:14px; min-height:320px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; }
    .state-badge { padding:10px 18px; border-radius:24px; font-weight:800; }
    .qr-code-container { width:180px; height:180px; background:#fff; border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:center; }
    .order-details { background: rgba(255,255,255,0.06); padding:14px; border-radius:12px; width:100%; max-width:420px; }
    .pickup-message { background:linear-gradient(90deg,#22c55e,#16a34a); color:white; padding:12px; border-radius:12px; font-weight:800; text-align:center; }
    .state-diagram { margin-top:18px; color:#c7d2fe; font-size:13px; opacity:0.9; text-align:center; }
    .console-log { font-family: monospace; background: rgba(0,0,0,0.6); padding:8px; border-radius:8px; margin-top:12px; max-height:140px; overflow:auto; color:#10b981; }
  </style>
</head>
<body>
  <div class="machine-screen">
    <div class="machine-title">ğŸ¤– VENDING MACHINE - Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</div>
    <div id="displayArea" class="display-area">
      <!-- ÙŠØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
      <div class="state-badge" id="initialBadge">ğŸ”µ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</div>
    </div>

    <div class="state-diagram">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ØªØªØ­ÙˆÙ„ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„Ø¯ÙØ¹.</div>
    <div class="console-log" id="consoleLogs"><div>[SYSTEM] Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div></div>
  </div>

  <script type="module">
    // ---------- Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ÙˆØ­Ù‘Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) ----------
    const STATES = {
      IDLE: 'IDLE',
      PRODUCT_SELECTED: 'PRODUCT_SELECTED',
      WAITING_PAYMENT: 'WAITING_PAYMENT',
      PAYMENT_CONFIRMED: 'PAYMENT_CONFIRMED',
      DISPENSING: 'DISPENSING',
      RETURNING_CHANGE: 'RETURNING_CHANGE',
      COMPLETE: 'COMPLETE'
    };

    // Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (ØºÙŠØ±ÙŠ Ø¥Ø°Ø§ Ø§Ø³ØªØ¶ÙØªÙÙ‡Ø§ Ø¨Ù…ÙƒØ§Ù† Ø¢Ø®Ø±)
    const MOBILE_APP_URL = 'https://ayah-saleem.github.io/mobile-payment/mobile.html';

    // MACHINE ID Ø«Ø§Ø¨Øª Ø£Ùˆ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡
    const MACHINE_ID = 'VM-001';

    // Helper: ÙŠØ³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„ØµØºÙŠØ±Ø©
    function logToConsole(message) {
      const el = document.getElementById('consoleLogs');
      const d = document.createElement('div');
      d.textContent = message;
      el.appendChild(d);
      if (el.children.length > 30) el.removeChild(el.firstChild);
      el.scrollTop = el.scrollHeight;
    }

    // --------- EventBus Ø¨Ø³ÙŠØ· ----------
    class EventBus {
      constructor() { this.listeners = {}; }
      subscribe(eventType, cb) {
        (this.listeners[eventType] = this.listeners[eventType]||[]).push(cb);
      }
      publish(eventType, data) {
        logToConsole(`[EVENT] ${eventType}`);
        if (this.listeners[eventType]) this.listeners[eventType].forEach(cb => cb(data));
      }
    }

    const Events = {
      PRODUCT_SELECTED: 'PRODUCT_SELECTED',
      PAYMENT_RECEIVED: 'PAYMENT_RECEIVED',
      PAYMENT_CONFIRMED: 'PAYMENT_CONFIRMED',
      DISPENSING_STARTED: 'DISPENSING_STARTED',
      DISPENSING_COMPLETE: 'DISPENSING_COMPLETE',
      CHANGE_RETURNED: 'CHANGE_RETURNED',
      TRANSACTION_COMPLETE: 'TRANSACTION_COMPLETE',
      RESET_TO_IDLE: 'RESET_TO_IDLE',
      QR_SCANNED: 'QR_SCANNED'
    };

    // --------- State Pattern (Ù…Ø¨Ø³Ù‘Ø· ÙˆÙØ¹Ø§Ù„) ----------
    class BaseState {
      constructor(ctx) { this.ctx = ctx; }
      enter() { logToConsole(`[STATE] Enter ${this.constructor.name}`); }
      exit() { logToConsole(`[STATE] Exit ${this.constructor.name}`); }
      handleEvent(evt, data) { /* Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */ }
      getName() { return this.constructor.name.replace('State','').toUpperCase(); }
    }

    class IdleState extends BaseState {
      enter() {
        super.enter();
        this.ctx.session = { state: STATES.IDLE, selectedProduct: null, amountPaid:0, change:0 };
        this.ctx.view.render(this.ctx.session);
      }
      handleEvent(evt,data) {
        if (evt === Events.QR_SCANNED) {
          // Ù…Ø³Ø­ QR: Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ Ø¥Ù„Ù‰ waiting selection
          this.ctx.transitionTo(new WaitingForSelectionState(this.ctx));
        } else if (evt === Events.PRODUCT_SELECTED) {
          this.ctx.session.selectedProduct = data;
          this.ctx.transitionTo(new ProductSelectedState(this.ctx));
        }
      }
    }

    class WaitingForSelectionState extends BaseState {
      enter() { super.enter(); this.ctx.session.state = STATES.PRODUCT_SELECTED; this.ctx.view.render(this.ctx.session); }
      handleEvent(evt,data) {
        if (evt === Events.PRODUCT_SELECTED) {
          this.ctx.session.selectedProduct = data;
          this.ctx.transitionTo(new ProductSelectedState(this.ctx));
        }
      }
    }

    class ProductSelectedState extends BaseState {
      enter() { super.enter(); this.ctx.session.state = STATES.PRODUCT_SELECTED; this.ctx.session.amountPaid=0; this.ctx.view.render(this.ctx.session); }
      handleEvent(evt,data) {
        if (evt === Events.PAYMENT_RECEIVED) {
          this.ctx.session.amountPaid += data.amount;
          this.ctx.session.change = this.ctx.session.amountPaid - this.ctx.session.selectedProduct.price;
          this.ctx.transitionTo(new WaitingPaymentState(this.ctx));
        }
      }
    }

    class WaitingPaymentState extends BaseState {
      enter() { super.enter(); this.ctx.session.state = STATES.WAITING_PAYMENT; this.ctx.view.render(this.ctx.session); }
      handleEvent(evt,data) {
        if (evt === Events.PAYMENT_RECEIVED) {
          this.ctx.session.amountPaid += data.amount;
          this.ctx.session.change = this.ctx.session.amountPaid - this.ctx.session.selectedProduct.price;
          this.ctx.view.render(this.ctx.session);
        } else if (evt === Events.PAYMENT_CONFIRMED) {
          this.ctx.session.change = this.ctx.session.amountPaid - this.ctx.session.selectedProduct.price;
          this.ctx.transitionTo(new PaymentConfirmedState(this.ctx));
        }
      }
    }

    class PaymentConfirmedState extends BaseState {
      enter() {
        super.enter();
        this.ctx.session.state = STATES.PAYMENT_CONFIRMED;
        this.ctx.view.render(this.ctx.session);
        setTimeout(()=> this.ctx.eventBus.publish(Events.DISPENSING_STARTED, {}), 800);
      }
      handleEvent(evt,data) {
        if (evt === Events.DISPENSING_STARTED) this.ctx.transitionTo(new DispensingState(this.ctx));
      }
    }

    class DispensingState extends BaseState {
      enter() {
        super.enter();
        this.ctx.session.state = STATES.DISPENSING;
        this.ctx.view.render(this.ctx.session);
        setTimeout(()=> this.ctx.eventBus.publish(Events.DISPENSING_COMPLETE, {}), 3000);
      }
      handleEvent(evt,data) {
        if (evt === Events.DISPENSING_COMPLETE) {
          if (this.ctx.session.change > 0) this.ctx.transitionTo(new ReturningChangeState(this.ctx));
          else this.ctx.transitionTo(new CompleteState(this.ctx));
        }
      }
    }

    class ReturningChangeState extends BaseState {
      enter() {
        super.enter();
        this.ctx.session.state = STATES.RETURNING_CHANGE;
        this.ctx.view.render(this.ctx.session);
        setTimeout(()=> this.ctx.eventBus.publish(Events.CHANGE_RETURNED, {}), 1600);
      }
      handleEvent(evt,data) {
        if (evt === Events.CHANGE_RETURNED) this.ctx.transitionTo(new CompleteState(this.ctx));
      }
    }

    class CompleteState extends BaseState {
      enter() {
        super.enter();
        this.ctx.session.state = STATES.COMPLETE;
        this.ctx.view.render(this.ctx.session);
        setTimeout(()=> this.ctx.eventBus.publish(Events.RESET_TO_IDLE, {}), 4500);
      }
      handleEvent(evt,data) {
        if (evt === Events.RESET_TO_IDLE) this.ctx.transitionTo(new IdleState(this.ctx));
      }
    }

    // --------- View (Ø¹Ø±Ø¶ ÙÙ‚Ø·) ----------
    class VendingMachineView {
      constructor(container) { this.container = container; this.qrGenerated=false; }
      render(session) {
        const state = session.state || STATES.IDLE;
        let html = '';

        if (state === STATES.IDLE) {
          html = `
            <div class="state-badge" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);">ğŸ”µ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</div>
            <div class="qr-title">âš¡ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¨Ø¯Ø¡ âš¡</div>
            <div class="qr-code-container"><div id="qrcode"></div></div>
            <div style="opacity:0.9;">ğŸ“± Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù‡Ø§ØªÙÙƒ Ù„Ù„Ø¨Ø¯Ø¡</div>
          `;
          this.container.innerHTML = html;
          if (!this.qrGenerated) this.generateQRCode();
        } else {
          // Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰ ØªØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ùˆ Ø§Ù„Ø­Ø§Ù„Ø©
          const product = session.selectedProduct || { name:'-', price:0, icon:'' };
          html = `
            <div class="state-badge" style="background:linear-gradient(90deg,#f59e0b,#f97316);">${state}</div>
            <div class="order-details">
              <div>Ø§Ù„Ù…Ù†ØªØ¬: ${product.icon} ${product.name}</div>
              <div>Ø§Ù„Ø³Ø¹Ø±: ${product.price} Ø±.Ø³</div>
              <div>Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${session.amountPaid || 0} Ø±.Ø³</div>
              ${session.change>0? `<div>Ø§Ù„Ø¨Ø§Ù‚ÙŠ: ${session.change} Ø±.Ø³</div>`:''}
            </div>
            ${state === STATES.COMPLETE ? `<div class="pickup-message">ğŸ“¦ Ø§Ø³ØªÙ„Ù… Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</div>` : ''}
          `;
          this.container.innerHTML = html;
        }
      }

      generateQRCode() {
        const container = document.getElementById('qrcode');
        if (!container) return;
        const mobileUrl = `${MOBILE_APP_URL}?machine=${MACHINE_ID}`;
        container.innerHTML = '';
        // Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø© QRCodeJS (Ø²ÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
        new QRCode(container, {
          text: mobileUrl,
          width: 170,
          height: 170,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
        this.qrGenerated = true;
        logToConsole(`[QR] Ù…ÙˆÙ„Ø¯: ${mobileUrl}`);
      }
    }

    // --------- Model + Context (ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆÙŠÙØ³Ù‘Ø± Ø§Ù„Ù€ Firebase) ----------
    class VendingMachineContext {
      constructor(machineId) {
        this.machineId = machineId;
        this.eventBus = new EventBus();
        this.view = new VendingMachineView(document.getElementById('displayArea'));
        this.session = {};
        this.currentState = null;

        // EventBus to local state
        Object.values(Events).forEach(e => {
          this.eventBus.subscribe(e, (data)=> {
            if (this.currentState && typeof this.currentState.handleEvent === 'function') {
              this.currentState.handleEvent(e,data);
            }
          });
        });

        // Listen to firebase updates
        this.setupFirebaseListener();

        // start
        this.transitionTo(new IdleState(this));
      }

      transitionTo(newState) {
        logToConsole(`[TRANSITION] ${this.currentState ? this.currentState.getName() : 'null'} â†’ ${newState.getName()}`);
        if (this.currentState) this.currentState.exit();
        this.currentState = newState;
        this.currentState.enter();
        // update firebase snapshot on transition
        this.pushSessionToFirebase();
      }

      pushSessionToFirebase() {
        if (!window.MACHINE_DB) return;
        const sessionRef = window.DB_ref(window.MACHINE_DB, `sessions/${this.machineId}`);
        const payload = {
          state: this.session.state || STATES.IDLE,
          selectedProductId: this.session.selectedProduct?.id || null,
          selectedProductName: this.session.selectedProduct?.name || null,
          selectedProductIcon: this.session.selectedProduct?.icon || null,
          selectedProductPrice: this.session.selectedProduct?.price || 0,
          amountPaid: this.session.amountPaid || 0,
          change: this.session.change || 0,
          timestamp: Date.now()
        };
        window.DB_set(sessionRef, payload).catch(err => logToConsole(`[FIREBASE ERR] ${err.message}`));
      }

      setupFirebaseListener() {
        if (!window.MACHINE_DB) return;
        const sessionRef = window.DB_ref(window.MACHINE_DB, `sessions/${this.machineId}`);
        window.DB_onValue(sessionRef, (snap) => {
          const data = snap.val();
          if (!data) return;
          // map incoming firebase state to local events
          // Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø­Ø§Ù„Ø§ØªØŒ Ù†Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Events Ù…Ø­Ù„ÙŠØ§Ù‹
          logToConsole(`[FIREBASE] Ø§Ø³ØªÙ„Ù…Ù†Ø§ state=${data.state}`);
          switch (data.state) {
            case STATES.PRODUCT_SELECTED:
              if (data.selectedProductId) {
                this.eventBus.publish(Events.PRODUCT_SELECTED, {
                  id: data.selectedProductId,
                  name: data.selectedProductName,
                  icon: data.selectedProductIcon,
                  price: data.selectedProductPrice
                });
              }
              break;
            case STATES.WAITING_PAYMENT:
              if (typeof data.amountPaid === 'number') {
                this.eventBus.publish(Events.PAYMENT_RECEIVED, { amount: data.amountPaid });
              }
              break;
            case STATES.PAYMENT_CONFIRMED:
              this.eventBus.publish(Events.PAYMENT_CONFIRMED, {});
              break;
            case STATES.COMPLETE:
              this.eventBus.publish(Events.TRANSACTION_COMPLETE, {});
              break;
            case STATES.IDLE:
              this.eventBus.publish(Events.RESET_TO_IDLE, {});
              break;
            default:
              // other states can be ignored or handled
              break;
          }
        });
      }
    }

    // ---------- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ----------
    document.addEventListener('DOMContentLoaded', ()=> {
      const ctx = new VendingMachineContext(MACHINE_ID);

      // Event: when QR is scanned (mobile writes to firebase), machine will detect via firebase listener.
      // Ù„ÙƒÙ† Ù„Ùˆ Ø£Ø±Ø¯ØªÙŠ Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø­Ù„ÙŠØ§Ù‹: Ø§Ø¶ØºØ·ÙŠ Ù‡Ù†Ø§ Ù„Ù…Ø­Ø§ÙƒØ§Ø© QR:
      const disp = document.getElementById('displayArea');
      disp.addEventListener('dblclick', ()=> {
        ctx.eventBus.publish(Events.QR_SCANNED, {});
      });

      logToConsole('[SYSTEM] Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ù…ÙØ´ØºÙ‘Ù„Ø©');
    });
  </script>
</body>
</html>
