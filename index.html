<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Vending Machine - State Machine Implementation</title>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBzKF_fuEKbSP-8JuBZb9QkuMj9eGcBsYw",
            authDomain: "advanced-vending-machine.firebaseapp.com",
            databaseURL: "https://advanced-vending-machine-default-rtdb.firebaseio.com",
            projectId: "advanced-vending-machine",
            storageBucket: "advanced-vending-machine.firebasestorage.app",
            messagingSenderId: "119768375164",
            appId: "1:119768375164:web:d96d14021f495869474ef9",
            measurementId: "G-9935V0NKQ1"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseOnValue = onValue;
        window.firebaseInitialized = true;
    </script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
            width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        * {
            box-sizing: border-box;
        }

        .machine-screen {
            width: 90%;
            max-width: 1400px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 30px;
            padding: 40px 30px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(99, 102, 241, 0.3),
                inset 0 0 30px rgba(99, 102, 241, 0.1);
            border: 3px solid rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .machine-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .machine-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .machine-title {
            font-size: 42px;
            font-weight: 900;
            color: #ffffff;
            margin: 0;
            text-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
            animation: pulse 3s ease-in-out infinite;
            letter-spacing: 2px;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        /* Display Area */
        .display-area {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
            border-radius: 25px;
            padding: 30px;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(99, 102, 241, 0.2);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(99, 102, 241, 0.2);
            margin-bottom: 30px;
            z-index: 1;
        }

        .display-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 70%),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(99, 102, 241, 0.03) 2px, rgba(99, 102, 241, 0.03) 4px);
            pointer-events: none;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .qr-display {
            text-align: center;
            animation: fadeInUp 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            z-index: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .qr-code-container {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin: 0 auto 20px;
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4), 0 0 0 5px rgba(99, 102, 241, 0.2);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        #qrcode {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qrcode img {
            display: block;
            margin: 0 auto;
            border-radius: 15px;
        }

        .qr-instruction {
            font-size: 16px;
            color: #ffffff;
            margin-bottom: 6px;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
        }

        .qr-subtext {
            font-size: 13px;
            color: #a5b4fc;
            font-weight: 600;
        }

        .timer-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 8px 15px;
            margin-top: 10px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            display: inline-block;
        }

        .timer-text {
            color: #fbbf24;
            font-weight: 700;
            font-size: 13px;
        }

        .timer-value {
            color: #ffffff;
            font-weight: 900;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.8);
        }

        .order-details {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 3px solid #6366f1;
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            max-width: 400px;
            width: 100%;
            position: relative;
            z-index: 1;
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.3);
            animation: fadeInUp 0.5s ease-out;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-label {
            color: #a5b4fc;
            font-weight: 700;
        }

        .order-value {
            font-weight: 900;
            font-size: 18px;
            text-shadow: 0 0 8px rgba(99, 102, 241, 0.5);
        }

        .pickup-message {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-top: 20px;
            font-size: 20px;
            font-weight: 900;
            text-align: center;
            animation: pulse 1.5s ease-in-out infinite;
            position: relative;
            z-index: 1;
            box-shadow: 0 15px 35px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* State Machine Diagram */
        .state-diagram-container {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
            border-radius: 25px;
            padding: 30px;
            border: 2px solid rgba(99, 102, 241, 0.2);
            box-shadow: inset 0 0 50px rgba(99, 102, 241, 0.2);
            position: relative;
            z-index: 1;
        }

        .diagram-title {
            font-size: 24px;
            font-weight: 900;
            color: #ffffff;
            margin-bottom: 25px;
            text-align: center;
        }

        .state-flow {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: auto auto;
            gap: 10px;
            align-items: center;
        }

        .state-node {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 12px 10px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }

        .state-node.active {
            border-color: #22c55e;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(16, 185, 129, 0.3) 100%);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6), inset 0 0 20px rgba(34, 197, 94, 0.2);
            transform: scale(1.05);
            animation: activeGlow 2s ease-in-out infinite;
        }

        @keyframes activeGlow {

            0%,
            100% {
                box-shadow: 0 0 30px rgba(34, 197, 94, 0.6), inset 0 0 20px rgba(34, 197, 94, 0.2);
            }

            50% {
                box-shadow: 0 0 50px rgba(34, 197, 94, 0.8), inset 0 0 30px rgba(34, 197, 94, 0.4);
            }
        }

        .state-node.completed {
            border-color: rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            opacity: 0.7;
        }

        .state-node-name {
            font-size: 11px;
            font-weight: 900;
            color: #ffffff;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .state-node-desc {
            font-size: 9px;
            color: #a5b4fc;
            font-weight: 600;
        }

        .state-arrow {
            text-align: center;
            font-size: 18px;
            color: #6366f1;
            animation: bounceX 2s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .state-arrow.active {
            color: #22c55e;
            animation: bounceX 1s ease-in-out infinite;
        }

        @keyframes bounceX {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(5px);
            }
        }

        /* Grid positioning */
        .state-node[data-state="IDLE"] {
            grid-column: 1;
            grid-row: 1;
        }

        .state-arrow:nth-child(2) {
            grid-column: 2;
            grid-row: 1;
        }

        .state-node[data-state="PRODUCT_SELECTED"] {
            grid-column: 3;
            grid-row: 1;
        }

        .state-arrow:nth-child(4) {
            grid-column: 4;
            grid-row: 1;
        }

        .state-node[data-state="WAITING_PAYMENT"] {
            grid-column: 5;
            grid-row: 1;
        }

        .state-arrow:nth-child(6) {
            grid-column: 6;
            grid-row: 1;
        }

        .state-node[data-state="PAYMENT_CONFIRMED"] {
            grid-column: 7;
            grid-row: 1;
        }

        .state-arrow:nth-child(8) {
            grid-column: 8;
            grid-row: 1;
            transform: rotate(90deg);
        }

        .state-node[data-state="DISPENSING"] {
            grid-column: 7;
            grid-row: 2;
        }

        .state-arrow:nth-child(10) {
            grid-column: 6;
            grid-row: 2;
            transform: scaleX(-1);
        }

        .state-node[data-state="RETURNING_CHANGE"] {
            grid-column: 5;
            grid-row: 2;
        }

        .state-arrow:nth-child(12) {
            grid-column: 4;
            grid-row: 2;
            transform: scaleX(-1);
        }

        .state-node[data-state="COMPLETE"] {
            grid-column: 3;
            grid-row: 2;
        }

        .state-arrow:nth-child(14) {
            grid-column: 2;
            grid-row: 2;
            transform: scaleX(-1);
        }

        @media (max-width: 768px) {
            .machine-screen {
                width: 95%;
                padding: 30px 20px;
            }

            .machine-title {
                font-size: 36px;
            }

            .display-area {
                padding: 25px 20px;
                min-height: 280px;
            }

            .qr-code-container {
                width: 180px;
                height: 180px;
            }

            .state-node-name {
                font-size: 9px;
            }

            .state-node-desc {
                font-size: 8px;
            }
        }
    </style>
    <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>

<body>
    <div class="machine-screen">
        <header class="machine-header">
            <h1 class="machine-title">ü§ñ VENDING MACHINE</h1>
        </header>
        <main class="display-area" id="displayArea">
            <div class="qr-display">
                <div class="qr-code-container">
                    <div id="qrcode"></div>
                </div>
                <div class="qr-instruction">
                    üì± ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸàÿØ ÿ®Ÿáÿßÿ™ŸÅŸÉ ŸÑŸÑÿ®ÿØÿ°
                </div>
                <div class="qr-subtext">
                    Scan QR code to start payment
                </div>
            </div>
        </main>
        <div class="state-diagram-container">
            <div class="diagram-title">
                üìä State Machine Diagram
            </div>
            <div class="state-flow" id="stateFlow">
                <div class="state-node" data-state="IDLE">
                    <div class="state-node-name">
                        üîµ IDLE
                    </div>
                    <div class="state-node-desc">
                        ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
                    </div>
                </div>
                <div class="state-arrow">
                    ‚¨ÖÔ∏è
                </div>
                <div class="state-node" data-state="PRODUCT_SELECTED">
                    <div class="state-node-name">
                        üõí PRODUCT SELECTED
                    </div>
                    <div class="state-node-desc">
                        ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨
                    </div>
                </div>
                <div class="state-arrow">
                    ‚¨ÖÔ∏è
                </div>
                <div class="state-node" data-state="WAITING_PAYMENT">
                    <div class="state-node-name">
                        ‚è≥ WAITING PAYMENT
                    </div>
                    <div class="state-node-desc">
                        ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿØŸÅÿπ
                    </div>
                </div>
                <div class="state-arrow">
                    ‚¨ÖÔ∏è
                </div>
                <div class="state-node" data-state="PAYMENT_CONFIRMED">
                    <div class="state-node-name">
                        ‚úÖ PAYMENT CONFIRMED
                    </div>
                    <div class="state-node-desc">
                        ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÅÿπ
                    </div>
                </div>
                <div class="state-arrow">
                    ‚¨áÔ∏è
                </div>
                <div class="state-node" data-state="DISPENSING">
                    <div class="state-node-name">
                        ‚öôÔ∏è DISPENSING
                    </div>
                    <div class="state-node-desc">
                        ÿ¨ÿßÿ±Ÿä ÿßŸÑÿµÿ±ŸÅ
                    </div>
                </div>
                <div class="state-arrow">
                    ‚û°Ô∏è
                </div>
                <div class="state-node" data-state="RETURNING_CHANGE">
                    <div class="state-node-name">
                        üí∞ RETURNING CHANGE
                    </div>
                    <div class="state-node-desc">
                        ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ÿßŸÇŸä
                    </div>
                </div>
                <div class="state-arrow">
                    ‚û°Ô∏è
                </div>
                <div class="state-node" data-state="COMPLETE">
                    <div class="state-node-name">
                        ‚úÖ COMPLETE
                    </div>
                    <div class="state-node-desc">
                        ÿßŸÉÿ™ŸÖŸÑÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
/* ============================================================================
   VENDING MACHINE ‚Äî FINAL FSM IMPLEMENTATION
   ‚úî Same UI
   ‚úî Same Design
   ‚úî Event-driven FSM
   ‚úî No switch
   ‚úî QR Stable
============================================================================ */

const MACHINE_ID = 'VM-001';

/* =========================
   EVENTS (Œ£)
========================= */
const Events = {
    SESSION_CREATED: 'SESSION_CREATED',
    PRODUCT_SELECTED: 'PRODUCT_SELECTED',
    PAYMENT_STARTED: 'PAYMENT_STARTED',
    PAYMENT_CONFIRMED: 'PAYMENT_CONFIRMED',
    DISPENSE_STARTED: 'DISPENSE_STARTED',
    CHANGE_RETURNED: 'CHANGE_RETURNED',
    COMPLETED: 'COMPLETED',
    TIMEOUT: 'TIMEOUT',
    RESET: 'RESET'
};

/* =========================
   STATE BASE CLASS
========================= */
class State {
    constructor(name) {
        this.name = name;
    }
    enter(machine) {}
    onEvent(machine, event, data) {}
}

/* =========================
   STATES
========================= */

class IdleState extends State {
    constructor() { super('IDLE'); }
    enter(machine) {
        machine.showIdleScreen();
        machine.startIdleTimer();
    }
    onEvent(machine, event) {
        if (event === Events.SESSION_CREATED) {
            machine.transition(new ProductSelectedState());
        }
    }
}

class ProductSelectedState extends State {
    constructor() { super('PRODUCT_SELECTED'); }
    enter(machine) {
        machine.showProductSelected();
        machine.startSelectionTimer();
    }
    onEvent(machine, event) {
        if (event === Events.PAYMENT_STARTED) {
            machine.transition(new WaitingPaymentState());
        }
        if (event === Events.TIMEOUT) {
            machine.transition(new IdleState());
        }
    }
}

class WaitingPaymentState extends State {
    constructor() { super('WAITING_PAYMENT'); }
    enter(machine) {
        machine.showWaitingPayment();
        machine.startPaymentTimer();
    }
    onEvent(machine, event) {
        if (event === Events.PAYMENT_CONFIRMED) {
            machine.transition(new PaymentConfirmedState());
        }
        if (event === Events.TIMEOUT) {
            machine.transition(new IdleState());
        }
    }
}

class PaymentConfirmedState extends State {
    constructor() { super('PAYMENT_CONFIRMED'); }
    enter(machine) {
        machine.showPaymentConfirmed();
    }
    onEvent(machine, event) {
        if (event === Events.DISPENSE_STARTED) {
            machine.transition(new DispensingState());
        }
    }
}

class DispensingState extends State {
    constructor() { super('DISPENSING'); }
    enter(machine) {
        machine.showDispensing();
    }
    onEvent(machine, event) {
        if (event === Events.CHANGE_RETURNED) {
            machine.transition(new ReturningChangeState());
        }
        if (event === Events.COMPLETED) {
            machine.transition(new CompleteState());
        }
    }
}

class ReturningChangeState extends State {
    constructor() { super('RETURNING_CHANGE'); }
    enter(machine) {
        machine.showReturningChange();
    }
    onEvent(machine, event) {
        if (event === Events.COMPLETED) {
            machine.transition(new CompleteState());
        }
    }
}

class CompleteState extends State {
    constructor() { super('COMPLETE'); }
    enter(machine) {
        machine.showComplete();
        machine.startCompleteTimer();
    }
    onEvent(machine, event) {
        if (event === Events.RESET) {
            machine.transition(new IdleState());
        }
    }
}

/* =========================
   FSM ENGINE
========================= */
class VendingMachineFSM {
    constructor(view) {
        this.view = view;
        this.state = new IdleState();
        this.state.enter(this.view);
    }

    handleEvent(event, data = {}) {
        this.state.onEvent(this.view, event, data);
    }

    transition(newState) {
        this.state = newState;
        this.view.updateStateDiagram(this.state.name);
        this.state.enter(this.view);
    }
}

/* =========================
   VIEW + FIREBASE BINDING
========================= */
class VendingMachineDisplay {

    constructor() {
        this.displayArea = document.getElementById('displayArea');
        this.sessionData = {};
        this.fsm = new VendingMachineFSM(this);
        this.qrGenerated = false;
        this.waitForFirebase();
    }

    waitForFirebase() {
        if (window.firebaseInitialized) {
            this.listenToSession();
            this.generateQRCodeOnce();
        } else {
            setTimeout(() => this.waitForFirebase(), 100);
        }
    }

    listenToSession() {
        const refSession = window.firebaseRef(
            window.firebaseDB,
            `machines/${MACHINE_ID}/session`
        );

        window.firebaseOnValue(refSession, snap => {
            const s = snap.val();
            if (!s) {
                this.fsm.handleEvent(Events.RESET);
                return;
            }

            this.sessionData = s;

            const eventMap = {
                IDLE: Events.RESET,
                PRODUCT_SELECTED: Events.SESSION_CREATED,
                WAITING_PAYMENT: Events.PAYMENT_STARTED,
                PAYMENT_CONFIRMED: Events.PAYMENT_CONFIRMED,
                DISPENSING: Events.DISPENSE_STARTED,
                RETURNING_CHANGE: Events.CHANGE_RETURNED,
                COMPLETE: Events.COMPLETED
            };

            this.fsm.handleEvent(eventMap[s.state]);
        });
    }

    /* =========================
       QR (STABLE)
    ========================= */
    generateQRCodeOnce() {
        if (this.qrGenerated) return;
        const qr = document.getElementById('qrcode');
        if (!qr) return;

        new QRCode(qr, {
            text: `https://ayah-saleem.github.io/mobile-payment/mobile.html?machine=${MACHINE_ID}`,
            width: 170,
            height: 170,
            correctLevel: QRCode.CorrectLevel.H
        });

        this.qrGenerated = true;
    }

    /* =========================
       TIMERS
    ========================= */
    startIdleTimer() { this.setTimer(() => this.fsm.handleEvent(Events.TIMEOUT), 120); }
    startSelectionTimer() { this.setTimer(() => this.fsm.handleEvent(Events.TIMEOUT), 60); }
    startPaymentTimer() { this.setTimer(() => this.fsm.handleEvent(Events.TIMEOUT), 60); }
    startCompleteTimer() { this.setTimer(() => this.fsm.handleEvent(Events.RESET), 60); }

    setTimer(cb, sec) {
        clearTimeout(this.timer);
        this.timer = setTimeout(cb, sec * 1000);
    }

    /* =========================
       UI METHODS (UNCHANGED)
    ========================= */
    showIdleScreen() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="qr-code-container">
                            <div id="qrcode"></div>
                        </div>
                        <div class="qr-instruction">üì± ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸàÿØ ÿ®Ÿáÿßÿ™ŸÅŸÉ ŸÑŸÑÿ®ÿØÿ°</div>
                        <div class="qr-subtext">Scan QR code to start payment</div>
                    </div>
                `;
           }
    showProductSelected() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="order-details">
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                <span class="order-value">${this.sessionData.productIcon || ''} ${this.sessionData.productName || ''}</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                                <span class="order-value">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">‚è∞ ÿßŸÑŸàŸÇÿ™ ŸÑŸÑÿØŸÅÿπ:</span>
                                <span class="order-value">60 ÿ´ÿßŸÜŸäÿ©</span>
                            </div>
                        </div>
                        <div class="timer-info">
                            <span class="timer-text">‚è∞ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑŸÑÿØŸÅÿπ:</span>
                            <span class="timer-value">60</span> ÿ´ÿßŸÜŸäÿ©
                        </div>
                    </div>
                `;
                
                this.startSelectionTimer(60);
            }
    showWaitingPayment() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="order-details">
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                <span class="order-value">${this.sessionData.productIcon || ''} ${this.sessionData.productName || ''}</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                                <span class="order-value">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖÿ∑ŸÑŸàÿ®:</span>
                                <span class="order-value" style="color: #fbbf24;">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                        </div>
                        <div class="timer-info">
                            <span class="timer-text">‚è∞ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑŸÑÿ•ŸÑÿ∫ÿßÿ°:</span>
                            <span class="timer-value">60</span> ÿ´ÿßŸÜŸäÿ©
                        </div>
                    </div>
                `;
                
                this.startPaymentTimer(60); }
    showPaymentConfirmed() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="order-details">
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                <span class="order-value">${this.sessionData.productIcon || ''} ${this.sessionData.productName || ''}</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                                <span class="order-value">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖÿØŸÅŸàÿπ:</span>
                                <span class="order-value" style="color: #22c55e;">${(this.sessionData.amountPaid || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                        </div>
                    </div>
                `;
             }
    showDispensing() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="order-details">
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                <span class="order-value">${this.sessionData.productIcon || ''} ${this.sessionData.productName || ''}</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                                <span class="order-value">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖÿØŸÅŸàÿπ:</span>
                                <span class="order-value" style="color: #22c55e;">${(this.sessionData.amountPaid || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">‚è∞ ÿßŸÑÿ≠ÿßŸÑÿ©:</span>
                                <span class="order-value">ÿ¨ÿßÿ±Ÿä ÿµÿ±ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨...</span>
                            </div>
                        </div>
                    </div>
                `;
           }
    showReturningChange() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="order-details">
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                <span class="order-value">${this.sessionData.productIcon || ''} ${this.sessionData.productName || ''}</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                                <span class="order-value">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖÿØŸÅŸàÿπ:</span>
                                <span class="order-value" style="color: #22c55e;">${(this.sessionData.amountPaid || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ®ÿßŸÇŸä:</span>
                                <span class="order-value" style="color: #fbbf24;">${(this.sessionData.change || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">‚è∞ ÿßŸÑÿ≠ÿßŸÑÿ©:</span>
                                <span class="order-value">ÿ¨ÿßÿ±Ÿä ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ÿßŸÇŸä...</span>
                            </div>
                        </div>
                    </div>
                `;
             }
    showComplete() { 
                this.displayArea.innerHTML = `
                    <div class="qr-display">
                        <div class="order-details">
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                <span class="order-value">${this.sessionData.productIcon || ''} ${this.sessionData.productName || ''}</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                                <span class="order-value">${(this.sessionData.productPrice || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑŸÖÿØŸÅŸàÿπ:</span>
                                <span class="order-value" style="color: #22c55e;">${(this.sessionData.amountPaid || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            ${(this.sessionData.change || 0) > 0 ? `
                            <div class="order-item">
                                <span class="order-label">ÿßŸÑÿ®ÿßŸÇŸä:</span>
                                <span class="order-value" style="color: #fbbf24;">${(this.sessionData.change || 0).toFixed(2)} ‚Ç™</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="pickup-message">
                            üì¶ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ!
                        </div>
                        <div class="timer-info">
                            <span class="timer-text">‚è∞ ÿßŸÑÿπŸàÿØÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿÆŸÑÿßŸÑ:</span>
                            <span class="timer-value">60</span> ÿ´ÿßŸÜŸäÿ©
                        </div>
                    </div>
                `;
                this.startCompleteTimer(60);
            }

    updateStateDiagram(state) {
        document.querySelectorAll('.state-node').forEach(n => {
            n.classList.toggle('active', n.dataset.state === state);
        });
    }
}

window.addEventListener('load', () => {
    new VendingMachineDisplay();
});
</script>

    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9a97044305f05daa',t:'MTc2NDk3NDEyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
