<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 
    ‚úÖ STATE DESIGN PATTERN FOR MOBILE
    ‚úÖ EVENT-DRIVEN ARCHITECTURE
    ‚úÖ MODEL-VIEW SEPARATION
    -->
    
    <title>Mobile Payment - State Pattern</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        /* RESET */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* BODY */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* MOBILE CONTAINER */
        .mobile-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* HEADER */
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .mobile-title {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 10px;
        }
        
        .machine-id {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 600;
        }
        
        /* STATUS BADGE */
        .status-badge {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            margin: 15px 0;
            text-transform: uppercase;
        }
        
        .status-badge.idle { background: #10b981; color: white; }
        .status-badge.product-selected { background: #f59e0b; color: white; }
        .status-badge.waiting-payment { background: #3b82f6; color: white; }
        .status-badge.payment-confirmed { background: #8b5cf6; color: white; }
        .status-badge.dispensing { background: #ec4899; color: white; }
        .status-badge.complete { background: #10b981; color: white; }
        
        /* SECTIONS */
        .section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e7ff;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* PRODUCTS */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .product-card {
            background: white;
            border: 3px solid #e0e7ff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }
        
        .product-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f2ff 0%, #e0e7ff 100%);
        }
        
        .product-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .product-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .product-price {
            font-size: 18px;
            font-weight: 900;
            color: #667eea;
        }
        
        /* MONEY */
        .money-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .money-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 20px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .money-btn:hover:not(:disabled) {
            transform: translateY(-3px);
        }
        
        .money-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* SUMMARY */
        .summary-card {
            background: linear-gradient(135deg, #f0f2ff 0%, #e0e7ff 100%);
            border: 3px solid #c7d2fe;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .summary-label {
            font-weight: 600;
            color: #6b7280;
        }
        
        .summary-value {
            font-weight: 900;
            color: #667eea;
            font-size: 22px;
        }
        
        .summary-value.positive {
            color: #10b981;
        }
        
        .summary-value.negative {
            color: #ef4444;
        }
        
        /* BUTTONS */
        .confirm-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: 22px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-3px);
        }
        
        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* SUCCESS */
        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-icon {
            font-size: 80px;
            margin-bottom: 15px;
        }
        
        .success-text {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 15px;
        }
        
        .success-details {
            font-size: 18px;
            opacity: 0.95;
        }
        
        .reset-btn {
            background: white;
            color: #667eea;
            border: 3px solid white;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* UTILITY */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* RESPONSIVE */
        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .money-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <header class="mobile-header">
            <h1 class="mobile-title">üì± Mobile Payment</h1>
            <div class="machine-id" id="machineIdDisplay">Machine: Loading...</div>
            <div class="status-badge idle" id="statusBadge">üü¢ Ready</div>
        </header>
        
        <main id="mainContent">
            <section class="section" id="productSection">
                <h2 class="section-title"><span>üõí</span> <span>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨</span></h2>
                <div class="products-grid" id="productsGrid"></div>
            </section>
            
            <section class="section" id="paymentSection">
                <h2 class="section-title"><span>üíµ</span> <span>ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫</span></h2>
                <div class="money-grid" id="moneyGrid"></div>
                <div class="summary-card">
                    <div class="summary-row">
                        <span class="summary-label">ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®:</span>
                        <span class="summary-value" id="requiredAmount">0 ÿ±.ÿ≥</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ:</span>
                        <span class="summary-value" id="paidAmount">0 ÿ±.ÿ≥</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">ÿßŸÑÿ®ÿßŸÇŸä:</span>
                        <span class="summary-value" id="changeAmount">0 ÿ±.ÿ≥</span>
                    </div>
                </div>
                <button class="confirm-btn" id="confirmBtn" disabled>ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÅÿπ</button>
            </section>
        </main>
        
        <div id="successMessage" class="hidden"></div>
    </div>

    <script>
        // ============================================
        // üèóÔ∏è ARCHITECTURE DOCUMENTATION
        // ============================================
        /*
        ‚úÖ STATE DESIGN PATTERN FOR MOBILE
        ‚úÖ EVENT-DRIVEN ARCHITECTURE
        ‚úÖ MODEL-VIEW SEPARATION
        */
        
        // ============================================
        // 1Ô∏è‚É£ STATE DESIGN PATTERN (MOBILE)
        // ============================================
        
        class MobileState {
            constructor(name) {
                this.name = name;
            }
            
            enter(context) {
                console.log(`[MOBILE_STATE] Entering ${this.name}`);
            }
            
            exit(context) {}
            
            handleEvent(event, context) {
                console.log(`[MOBILE_STATE] ${this.name} handling ${event.type}`);
            }
        }
        
        class MobileIdleState extends MobileState {
            constructor() {
                super('MOBILE_IDLE');
            }
            
            enter(context) {
                super.enter(context);
                context.view.showProductSelection();
                context.view.disablePaymentSection();
            }
            
            handleEvent(event, context) {
                super.handleEvent(event, context);
                if (event.type === 'PRODUCT_SELECTED') {
                    context.sessionData.selectedProduct = event.data.product;
                    context.transitionTo(new MobilePaymentState());
                }
            }
        }
        
        class MobilePaymentState extends MobileState {
            constructor() {
                super('MOBILE_PAYMENT');
            }
            
            enter(context) {
                super.enter(context);
                context.view.enablePaymentSection();
                context.view.updatePaymentSummary(context.sessionData);
            }
            
            handleEvent(event, context) {
                super.handleEvent(event, context);
                if (event.type === 'MONEY_ADDED') {
                    context.sessionData.amountPaid += event.data.amount;
                    context.sessionData.change = context.sessionData.amountPaid - 
                        context.sessionData.selectedProduct.price;
                    context.view.updatePaymentSummary(context.sessionData);
                    
                    if (context.sessionData.amountPaid >= context.sessionData.selectedProduct.price) {
                        context.view.enableConfirmButton();
                    }
                } else if (event.type === 'PAYMENT_CONFIRMED') {
                    context.transitionTo(new MobileWaitingState());
                }
            }
        }
        
        class MobileWaitingState extends MobileState {
            constructor() {
                super('MOBILE_WAITING');
            }
            
            enter(context) {
                super.enter(context);
                context.view.showProcessing();
                context.sendToMachine();
            }
            
            handleEvent(event, context) {
                super.handleEvent(event, context);
                if (event.type === 'TRANSACTION_COMPLETE') {
                    context.transitionTo(new MobileCompleteState());
                }
            }
        }
        
        class MobileCompleteState extends MobileState {
            constructor() {
                super('MOBILE_COMPLETE');
            }
            
            enter(context) {
                super.enter(context);
                context.view.showSuccess(context.sessionData);
            }
            
            handleEvent(event, context) {
                super.handleEvent(event, context);
                if (event.type === 'RESET') {
                    context.resetSession();
                    context.transitionTo(new MobileIdleState());
                }
            }
        }
        
        // ============================================
        // 2Ô∏è‚É£ EVENT-DRIVEN ARCHITECTURE (MOBILE)
        // ============================================
        
        class MobileEventBus {
            constructor() {
                this.listeners = {};
            }
            
            emit(eventType, data = {}) {
                console.log(`[MOBILE_EVENT] ${eventType}`, data);
                const event = { type: eventType, data, timestamp: Date.now() };
                
                if (this.listeners[eventType]) {
                    this.listeners[eventType].forEach(callback => callback(event));
                }
            }
            
            on(eventType, callback) {
                if (!this.listeners[eventType]) {
                    this.listeners[eventType] = [];
                }
                this.listeners[eventType].push(callback);
            }
        }
        
        // ============================================
        // 3Ô∏è‚É£ MODEL-VIEW SEPARATION (MOBILE)
        // ============================================
        
        // MODEL (Pure Data)
        class MobileModel {
            constructor() {
                this.products = [
                    { id: 'P1', name: 'ÿ®Ÿäÿ®ÿ≥Ÿä', icon: 'ü•§', price: 5 },
                    { id: 'P2', name: 'ÿ¥Ÿäÿ®ÿ≥', icon: 'üçü', price: 3 },
                    { id: 'P3', name: 'ÿ¥ŸàŸÉŸàŸÑÿßÿ™ÿ©', icon: 'üç´', price: 7 },
                    { id: 'P4', name: 'ŸÖÿßÿ°', icon: 'üíß', price: 2 },
                    { id: 'P5', name: 'ŸÇŸáŸàÿ©', icon: '‚òï', price: 10 },
                    { id: 'P6', name: 'ÿπÿµŸäÿ±', icon: 'üßÉ', price: 6 }
                ];
                
                this.moneyDenominations = [1, 5, 10, 20, 50, 100];
                this.sessionData = {
                    selectedProduct: null,
                    amountPaid: 0,
                    change: 0
                };
            }
            
            getProductById(id) {
                return this.products.find(p => p.id === id);
            }
            
            getAllProducts() {
                return [...this.products];
            }
            
            getMoneyDenominations() {
                return [...this.moneyDenominations];
            }
            
            addPayment(amount) {
                this.sessionData.amountPaid += amount;
                this.sessionData.change = this.sessionData.amountPaid - 
                    (this.sessionData.selectedProduct ? this.sessionData.selectedProduct.price : 0);
                return this.sessionData;
            }
            
            selectProduct(product) {
                this.sessionData.selectedProduct = product;
                this.sessionData.amountPaid = 0;
                this.sessionData.change = 0;
                return this.sessionData;
            }
            
            resetSession() {
                this.sessionData = {
                    selectedProduct: null,
                    amountPaid: 0,
                    change: 0
                };
                return this.sessionData;
            }
            
            isPaymentComplete() {
                if (!this.sessionData.selectedProduct) return false;
                return this.sessionData.amountPaid >= this.sessionData.selectedProduct.price;
            }
            
            getSessionData() {
                return { ...this.sessionData };
            }
        }
        
        // VIEW (Display Only)
        class MobileView {
            constructor(model) {
                this.model = model;
                this.statusBadge = document.getElementById('statusBadge');
                this.productsGrid = document.getElementById('productsGrid');
                this.moneyGrid = document.getElementById('moneyGrid');
                this.confirmBtn = document.getElementById('confirmBtn');
                this.mainContent = document.getElementById('mainContent');
                this.successMessage = document.getElementById('successMessage');
            }
            
            update(sessionData) {
                this.updatePaymentSummary(sessionData);
                this.updateProductSelection(sessionData);
                this.updateConfirmButton(sessionData);
            }
            
            updatePaymentSummary(sessionData) {
                document.getElementById('requiredAmount').textContent = 
                    `${sessionData.selectedProduct?.price || 0} ÿ±.ÿ≥`;
                document.getElementById('paidAmount').textContent = 
                    `${sessionData.amountPaid} ÿ±.ÿ≥`;
                
                const changeElement = document.getElementById('changeAmount');
                changeElement.textContent = `${sessionData.change} ÿ±.ÿ≥`;
                changeElement.className = 'summary-value';
                
                if (sessionData.change > 0) {
                    changeElement.classList.add('positive');
                } else if (sessionData.change < 0) {
                    changeElement.classList.add('negative');
                }
            }
            
            updateProductSelection(sessionData) {
                document.querySelectorAll('.product-card').forEach(card => {
                    card.classList.remove('selected');
                    if (sessionData.selectedProduct && 
                        card.dataset.productId === sessionData.selectedProduct.id) {
                        card.classList.add('selected');
                    }
                });
            }
            
            updateConfirmButton(sessionData) {
                if (sessionData.selectedProduct && 
                    sessionData.amountPaid >= sessionData.selectedProduct.price) {
                    this.confirmBtn.disabled = false;
                } else {
                    this.confirmBtn.disabled = true;
                }
            }
            
            showProductSelection() {
                this.mainContent.classList.remove('hidden');
                this.successMessage.classList.add('hidden');
                this.renderProducts();
                this.renderMoneyButtons();
            }
            
            renderProducts() {
                const products = this.model.getAllProducts();
                this.productsGrid.innerHTML = products.map(product => `
                    <div class="product-card" data-product-id="${product.id}">
                        <div class="product-icon">${product.icon}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price} ÿ±.ÿ≥</div>
                    </div>
                `).join('');
            }
            
            renderMoneyButtons() {
                const denominations = this.model.getMoneyDenominations();
                this.moneyGrid.innerHTML = denominations.map(amount => `
                    <button class="money-btn" data-amount="${amount}" disabled>
                        üíµ ${amount} ÿ±.ÿ≥
                    </button>
                `).join('');
            }
            
            disablePaymentSection() {
                document.querySelectorAll('.money-btn').forEach(btn => btn.disabled = true);
                this.confirmBtn.disabled = true;
            }
            
            enablePaymentSection() {
                document.querySelectorAll('.money-btn').forEach(btn => btn.disabled = false);
            }
            
            enableConfirmButton() {
                this.confirmBtn.disabled = false;
            }
            
            showProcessing() {
                this.confirmBtn.innerHTML = '<span class="loading"></span> ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...';
                this.confirmBtn.disabled = true;
                document.querySelectorAll('.product-card').forEach(card => card.classList.add('disabled'));
                document.querySelectorAll('.money-btn').forEach(btn => btn.disabled = true);
            }
            
            showSuccess(sessionData) {
                this.mainContent.classList.add('hidden');
                this.successMessage.classList.remove('hidden');
                this.successMessage.innerHTML = `
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <div class="success-text">ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠!</div>
                        <div class="success-details">
                            <div style="font-size: 48px; margin: 20px 0;">
                                ${sessionData.selectedProduct.icon}
                            </div>
                            <div style="font-size: 22px; font-weight: 700;">
                                ${sessionData.selectedProduct.name}
                            </div>
                            <div style="font-size: 20px; margin-top: 15px;">
                                ÿßŸÑÿ≥ÿπÿ±: ${sessionData.selectedProduct.price} ÿ±.ÿ≥
                            </div>
                            <div style="font-size: 20px; margin-top: 10px;">
                                ÿßŸÑŸÖÿØŸÅŸàÿπ: ${sessionData.amountPaid} ÿ±.ÿ≥
                            </div>
                            ${sessionData.change > 0 ? `
                                <div style="font-size: 20px; margin-top: 10px;">
                                    ÿßŸÑÿ®ÿßŸÇŸä: ${sessionData.change} ÿ±.ÿ≥
                                </div>
                            ` : ''}
                            <div style="font-size: 24px; margin-top: 25px; font-weight: 900;">
                                üéÅ ÿßÿ∞Ÿáÿ® ŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ ŸÖŸÜ ÿßŸÑŸÖÿßŸÉŸäŸÜÿ©!
                            </div>
                        </div>
                        <button class="reset-btn" id="resetBtn">üîÑ ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ</button>
                    </div>
                `;
            }
            
            updateStatusBadge(state) {
                const statusMap = {
                    'IDLE': { text: 'üü¢ Ready', class: 'idle' },
                    'PRODUCT_SELECTED': { text: 'üü° Product Selected', class: 'product-selected' },
                    'WAITING_PAYMENT': { text: 'üîµ Processing', class: 'waiting-payment' },
                    'PAYMENT_CONFIRMED': { text: 'üü£ Confirmed', class: 'payment-confirmed' },
                    'DISPENSING': { text: 'üî¥ Dispensing', class: 'dispensing' },
                    'COMPLETE': { text: 'üü¢ Complete', class: 'complete' }
                };
                
                const status = statusMap[state] || statusMap['IDLE'];
                this.statusBadge.textContent = status.text;
                this.statusBadge.className = `status-badge ${status.class}`;
            }
        }
        
        // ============================================
        // 4Ô∏è‚É£ MOBILE CONTEXT (State Machine)
        // ============================================
        
        class MobileContext {
            constructor(machineId) {
                this.machineId = machineId;
                this.model = new MobileModel();
                this.view = new MobileView(this.model);
                this.eventBus = new MobileEventBus();
                this.currentState = null;
                this.sessionData = this.model.getSessionData();
                
                this.registerEventHandlers();
                this.registerUIHandlers();
                this.transitionTo(new MobileIdleState());
            }
            
            registerEventHandlers() {
                const eventTypes = ['PRODUCT_SELECTED', 'MONEY_ADDED', 'PAYMENT_CONFIRMED', 
                                   'TRANSACTION_COMPLETE', 'RESET'];
                
                eventTypes.forEach(eventType => {
                    this.eventBus.on(eventType, (event) => {
                        if (this.currentState) {
                            this.currentState.handleEvent(event, this);
                        }
                    });
                });
            }
            
            registerUIHandlers() {
                // Product selection
                document.addEventListener('click', (e) => {
                    const productCard = e.target.closest('.product-card');
                    if (productCard && this.currentState.name === 'MOBILE_IDLE') {
                        const productId = productCard.dataset.productId;
                        const product = this.model.getProductById(productId);
                        
                        if (product) {
                            const sessionData = this.model.selectProduct(product);
                            this.view.update(sessionData);
                            this.eventBus.emit('PRODUCT_SELECTED', { product });
                            this.sendProductToFirebase(product);
                        }
                    }
                });
                
                // Money buttons
                document.addEventListener('click', (e) => {
                    const moneyBtn = e.target.closest('.money-btn');
                    if (moneyBtn && !moneyBtn.disabled) {
                        const amount = parseInt(moneyBtn.dataset.amount);
                        const sessionData = this.model.addPayment(amount);
                        this.view.update(sessionData);
                        this.eventBus.emit('MONEY_ADDED', { amount });
                        this.updatePaymentInFirebase(sessionData.amountPaid);
                    }
                });
                
                // Confirm button
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'confirmBtn' && !e.target.disabled) {
                        this.eventBus.emit('PAYMENT_CONFIRMED', {});
                        this.sendPaymentConfirmedToFirebase();
                    }
                });
                
                // Reset button
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'resetBtn') {
                        this.eventBus.emit('RESET', {});
                    }
                });
            }
            
            transitionTo(newState) {
                console.log(`[MOBILE_STATE] ${this.currentState?.name || 'null'} ‚Üí ${newState.name}`);
                
                if (this.currentState) {
                    this.currentState.exit(this);
                }
                
                this.currentState = newState;
                this.currentState.enter(this);
            }
            
            sendProductToFirebase(product) {
                if (!window.firebaseDatabase) return;
                
                const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
                window.firebaseSet(sessionRef, {
                    state: 'PRODUCT_SELECTED',
                    selectedProductId: product.id,
                    selectedProductName: product.name,
                    selectedProductIcon: product.icon,
                    selectedProductPrice: product.price,
                    amountPaid: 0,
                    change: 0,
                    timestamp: Date.now()
                });
            }
            
            updatePaymentInFirebase(amountPaid) {
                if (!window.firebaseDatabase) return;
                
                const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
                window.firebaseSet(sessionRef, {
                    state: 'WAITING_PAYMENT',
                    amountPaid: amountPaid,
                    timestamp: Date.now()
                });
            }
            
            sendPaymentConfirmedToFirebase() {
                if (!window.firebaseDatabase) return;
                
                const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
                window.firebaseSet(sessionRef, {
                    state: 'PAYMENT_CONFIRMED',
                    timestamp: Date.now()
                });
            }
            
            sendToMachine() {
                if (!window.firebaseDatabase) return;
                
                const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
                window.firebaseSet(sessionRef, {
                    state: 'WAITING_PAYMENT',
                    amountPaid: this.model.getSessionData().amountPaid,
                    timestamp: Date.now()
                });
            }
            
            resetSession() {
                this.model.resetSession();
                this.view.showProductSelection();
                
                if (window.firebaseDatabase) {
                    const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
                    window.firebaseSet(sessionRef, {
                        state: 'IDLE',
                        timestamp: Date.now()
                    });
                }
            }
        }
        
        // ============================================
        // 5Ô∏è‚É£ FIREBASE INITIALIZATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBzKF_fuEKbSP-8JuBZb9QkuMj9eGcBsYw",
            authDomain: "advanced-vending-machine.firebaseapp.com",
            databaseURL: "https://advanced-vending-machine-default-rtdb.firebaseio.com",
            projectId: "advanced-vending-machine",
            storageBucket: "advanced-vending-machine.firebasestorage.app",
            messagingSenderId: "119768375164",
            appId: "1:119768375164:web:d96d14021f495869474ef9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.firebaseDatabase = firebase.database();
        window.firebaseRef = (path) => firebase.database().ref(path);
        window.firebaseSet = (ref, data) => ref.set(data);
        window.firebaseOnValue = (ref, callback) => ref.on('value', callback);
        
        // ============================================
        // 6Ô∏è‚É£ APPLICATION INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Get machine ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const machineId = urlParams.get('machine') || 'VM-001';
            
            // Display machine ID
            document.getElementById('machineIdDisplay').textContent = `Machine: ${machineId}`;
            
            // Create Mobile Context
            const mobileContext = new MobileContext(machineId);
            
            // Listen to Firebase for machine state updates
            const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${machineId}`);
            window.firebaseOnValue(sessionRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                mobileContext.view.updateStatusBadge(data.state);
                
                if (data.state === 'COMPLETE' && mobileContext.currentState.name === 'MOBILE_WAITING') {
                    mobileContext.eventBus.emit('TRANSACTION_COMPLETE', {});
                }
            });
            
            console.log('[MOBILE] System Initialized Successfully');
        });
    </script>
</body>
</html>
