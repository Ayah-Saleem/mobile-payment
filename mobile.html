<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Payment - State Pattern</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      height: 100%;
      width: 100%;
    }

    html {
      height: 100%;
      width: 100%;
    }

    .mobile-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      background: white;
      min-height: 100%;
      padding: 20px;
    }

    .mobile-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .mobile-title {
      font-size: 28px;
      font-weight: 900;
      margin: 0 0 10px 0;
    }

    .machine-id {
      font-size: 16px;
      opacity: 0.95;
      font-weight: 600;
    }

    .status-badge {
      display: inline-block;
      padding: 12px 25px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 700;
      margin: 15px 0;
      text-transform: uppercase;
    }

    .status-badge.idle { background: #10b981; color: white; }
    .status-badge.product-selected { background: #f59e0b; color: white; }
    .status-badge.waiting-payment { background: #3b82f6; color: white; }
    .status-badge.payment-confirmed { background: #8b5cf6; color: white; }
    .status-badge.dispensing { background: #ec4899; color: white; }
    .status-badge.complete { background: #10b981; color: white; }

    .section {
      background: #f8f9ff;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #e0e7ff;
    }

    .section-title {
      font-size: 20px;
      font-weight: 900;
      color: #667eea;
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .product-card {
      background: white;
      border: 3px solid #e0e7ff;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
      border-color: #667eea;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
    }

    .product-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #f0f2ff 0%, #e0e7ff 100%);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .product-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .product-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .product-name {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .product-price {
      font-size: 18px;
      font-weight: 900;
      color: #667eea;
    }

    .money-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .money-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 20px;
      font-size: 20px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .money-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .money-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .summary-card {
      background: linear-gradient(135deg, #f0f2ff 0%, #e0e7ff 100%);
      border: 3px solid #c7d2fe;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .summary-label {
      font-weight: 600;
      color: #6b7280;
    }

    .summary-value {
      font-weight: 900;
      color: #667eea;
      font-size: 22px;
    }

    .summary-value.positive {
      color: #10b981;
    }

    .summary-value.negative {
      color: #ef4444;
    }

    .confirm-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 15px;
      padding: 20px;
      font-size: 22px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      margin-top: 20px;
    }

    .confirm-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #9ca3af;
    }

    .success-message {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 15px;
    }

    .success-text {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 15px;
    }

    .success-details {
      font-size: 18px;
      opacity: 0.95;
    }

    .reset-btn {
      background: white;
      color: #667eea;
      border: 3px solid white;
      border-radius: 12px;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    .reset-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: scale(1.05);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 480px) {
      .products-grid {
        grid-template-columns: 1fr;
      }

      .money-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  <script src="/_sdk/element_sdk.js"></script>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="mobile-container">
   <header class="mobile-header">
    <h1 class="mobile-title">ğŸ“± Mobile Payment</h1>
    <div class="machine-id" id="machineIdDisplay">
     Machine: Loading...
    </div>
    <div class="status-badge idle" id="statusBadge">
     ğŸŸ¢ Ready
    </div>
   </header>
   <main id="mainContent"><!-- Product Selection Section -->
    <section class="section" id="productSection">
     <h2 class="section-title"><span>ğŸ›’</span> <span>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</span></h2>
     <div class="products-grid" id="productsGrid"><!-- Products will be rendered here -->
     </div>
    </section><!-- Payment Section -->
    <section class="section" id="paymentSection">
     <h2 class="section-title"><span>ğŸ’µ</span> <span>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº</span></h2>
     <div class="money-grid" id="moneyGrid"><!-- Money buttons will be rendered here -->
     </div>
     <div class="summary-card">
      <div class="summary-row"><span class="summary-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span> <span class="summary-value" id="requiredAmount">0 Ø±.Ø³</span>
      </div>
      <div class="summary-row"><span class="summary-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <span class="summary-value" id="paidAmount">0 Ø±.Ø³</span>
      </div>
      <div class="summary-row"><span class="summary-label">Ø§Ù„Ø¨Ø§Ù‚ÙŠ:</span> <span class="summary-value" id="changeAmount">0 Ø±.Ø³</span>
      </div>
     </div><button class="confirm-btn" id="confirmBtn" disabled> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ </button>
    </section>
   </main><!-- Success Message (Hidden by default) -->
   <div id="successMessage" class="hidden"><!-- Will be rendered dynamically -->
   </div>
  </div>
  <script type="module">
    // ============================================
    // 1. STATE DESIGN PATTERN FOR MOBILE
    // ============================================

    /**
     * Base State for Mobile Application
     */
    class MobileState {
      constructor(name) {
        this.name = name;
      }

      enter(context) {
        throw new Error('enter() must be implemented');
      }

      exit(context) {}

      handleEvent(event, context) {
        throw new Error('handleEvent() must be implemented');
      }
    }

    /**
     * Mobile Idle State - Waiting for product selection
     */
    class MobileIdleState extends MobileState {
      constructor() {
        super('MOBILE_IDLE');
      }

      enter(context) {
        console.log('[MOBILE_STATE] Entering MobileIdleState');
        context.view.showProductSelection();
        context.view.disablePaymentSection();
      }

      handleEvent(event, context) {
        if (event.type === 'PRODUCT_SELECTED') {
          console.log('[MOBILE_EVENT] Product selected:', event.data);
          context.sessionData.selectedProduct = event.data.product;
          context.transitionTo(new MobilePaymentState());
        }
      }
    }

    /**
     * Mobile Payment State - Collecting payment
     */
    class MobilePaymentState extends MobileState {
      constructor() {
        super('MOBILE_PAYMENT');
      }

      enter(context) {
        console.log('[MOBILE_STATE] Entering MobilePaymentState');
        context.view.enablePaymentSection();
        context.view.updatePaymentSummary(context.sessionData);
      }

      handleEvent(event, context) {
        if (event.type === 'MONEY_ADDED') {
          console.log('[MOBILE_EVENT] Money added:', event.data.amount);
          context.sessionData.amountPaid += event.data.amount;
          context.sessionData.change = context.sessionData.amountPaid - context.sessionData.selectedProduct.price;
          context.view.updatePaymentSummary(context.sessionData);
          
          if (context.sessionData.amountPaid >= context.sessionData.selectedProduct.price) {
            context.view.enableConfirmButton();
          }
        } else if (event.type === 'PAYMENT_CONFIRMED') {
          console.log('[MOBILE_EVENT] Payment confirmed');
          context.transitionTo(new MobileWaitingState());
        }
      }
    }

    /**
     * Mobile Waiting State - Waiting for machine to process
     */
    class MobileWaitingState extends MobileState {
      constructor() {
        super('MOBILE_WAITING');
      }

      enter(context) {
        console.log('[MOBILE_STATE] Entering MobileWaitingState');
        context.view.showProcessing();
        context.sendToMachine();
      }

      handleEvent(event, context) {
        if (event.type === 'TRANSACTION_COMPLETE') {
          console.log('[MOBILE_EVENT] Transaction complete');
          context.transitionTo(new MobileCompleteState());
        }
      }
    }

    /**
     * Mobile Complete State - Transaction finished
     */
    class MobileCompleteState extends MobileState {
      constructor() {
        super('MOBILE_COMPLETE');
      }

      enter(context) {
        console.log('[MOBILE_STATE] Entering MobileCompleteState');
        context.view.showSuccess(context.sessionData);
      }

      handleEvent(event, context) {
        if (event.type === 'RESET') {
          console.log('[MOBILE_EVENT] Reset requested');
          context.resetSession();
          context.transitionTo(new MobileIdleState());
        }
      }
    }

    // ============================================
    // 2. EVENT-DRIVEN ARCHITECTURE (MOBILE)
    // ============================================

    /**
     * Mobile Event Bus
     */
    class MobileEventBus {
      constructor() {
        this.listeners = {};
      }

      emit(eventType, data = {}) {
        console.log(`[MOBILE_EVENT_BUS] Emitting: ${eventType}`, data);
        const event = { type: eventType, data, timestamp: Date.now() };
        
        if (this.listeners[eventType]) {
          this.listeners[eventType].forEach(callback => callback(event));
        }
      }

      on(eventType, callback) {
        if (!this.listeners[eventType]) {
          this.listeners[eventType] = [];
        }
        this.listeners[eventType].push(callback);
      }
    }

    // ============================================
    // 3. MODEL-VIEW SEPARATION (MOBILE)
    // ============================================

    /**
     * Mobile View - Pure UI Layer
     */
    class MobileView {
      constructor() {
        this.statusBadge = document.getElementById('statusBadge');
        this.productsGrid = document.getElementById('productsGrid');
        this.moneyGrid = document.getElementById('moneyGrid');
        this.confirmBtn = document.getElementById('confirmBtn');
        this.mainContent = document.getElementById('mainContent');
        this.successMessage = document.getElementById('successMessage');
        
        this.products = [
          { id: 'P1', name: 'Ø¨ÙŠØ¨Ø³ÙŠ', icon: 'ğŸ¥¤', price: 5 },
          { id: 'P2', name: 'Ø´ÙŠØ¨Ø³', icon: 'ğŸŸ', price: 3 },
          { id: 'P3', name: 'Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', icon: 'ğŸ«', price: 7 },
          { id: 'P4', name: 'Ù…Ø§Ø¡', icon: 'ğŸ’§', price: 2 },
          { id: 'P5', name: 'Ù‚Ù‡ÙˆØ©', icon: 'â˜•', price: 10 },
          { id: 'P6', name: 'Ø¹ØµÙŠØ±', icon: 'ğŸ§ƒ', price: 6 }
        ];

        this.moneyDenominations = [1, 5, 10, 20, 50, 100];
      }

      /**
       * Show product selection UI
       */
      showProductSelection() {
        this.mainContent.classList.remove('hidden');
        this.successMessage.classList.add('hidden');
        this.renderProducts();
        this.renderMoneyButtons();
      }

      /**
       * Render product cards
       */
      renderProducts() {
        this.productsGrid.innerHTML = this.products.map(product => `
          <div class="product-card" data-product-id="${product.id}">
            <div class="product-icon">${product.icon}</div>
            <div class="product-name">${product.name}</div>
            <div class="product-price">${product.price} Ø±.Ø³</div>
          </div>
        `).join('');
      }

      /**
       * Render money buttons
       */
      renderMoneyButtons() {
        this.moneyGrid.innerHTML = this.moneyDenominations.map(amount => `
          <button class="money-btn" data-amount="${amount}" disabled>
            ğŸ’µ ${amount} Ø±.Ø³
          </button>
        `).join('');
      }

      /**
       * Disable payment section
       */
      disablePaymentSection() {
        document.querySelectorAll('.money-btn').forEach(btn => btn.disabled = true);
        this.confirmBtn.disabled = true;
      }

      /**
       * Enable payment section
       */
      enablePaymentSection() {
        document.querySelectorAll('.money-btn').forEach(btn => btn.disabled = false);
      }

      /**
       * Enable confirm button
       */
      enableConfirmButton() {
        this.confirmBtn.disabled = false;
      }

      /**
       * Update payment summary
       */
      updatePaymentSummary(sessionData) {
        document.getElementById('requiredAmount').textContent = `${sessionData.selectedProduct.price} Ø±.Ø³`;
        document.getElementById('paidAmount').textContent = `${sessionData.amountPaid} Ø±.Ø³`;
        
        const changeElement = document.getElementById('changeAmount');
        changeElement.textContent = `${sessionData.change} Ø±.Ø³`;
        changeElement.className = 'summary-value';
        
        if (sessionData.change > 0) {
          changeElement.classList.add('positive');
        } else if (sessionData.change < 0) {
          changeElement.classList.add('negative');
        }
      }

      /**
       * Show processing state
       */
      showProcessing() {
        this.confirmBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        this.confirmBtn.disabled = true;
        document.querySelectorAll('.product-card').forEach(card => card.classList.add('disabled'));
        document.querySelectorAll('.money-btn').forEach(btn => btn.disabled = true);
      }

      /**
       * Show success message
       */
      showSuccess(sessionData) {
        this.mainContent.classList.add('hidden');
        this.successMessage.classList.remove('hidden');
        this.successMessage.innerHTML = `
          <div class="success-message">
            <div class="success-icon">âœ…</div>
            <div class="success-text">ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!</div>
            <div class="success-details">
              <div style="font-size: 48px; margin: 20px 0;">
                ${sessionData.selectedProduct.icon}
              </div>
              <div style="font-size: 22px; font-weight: 700;">
                ${sessionData.selectedProduct.name}
              </div>
              <div style="font-size: 20px; margin-top: 15px;">
                Ø§Ù„Ø³Ø¹Ø±: ${sessionData.selectedProduct.price} Ø±.Ø³
              </div>
              <div style="font-size: 20px; margin-top: 10px;">
                Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${sessionData.amountPaid} Ø±.Ø³
              </div>
              ${sessionData.change > 0 ? `
                <div style="font-size: 20px; margin-top: 10px;">
                  Ø§Ù„Ø¨Ø§Ù‚ÙŠ: ${sessionData.change} Ø±.Ø³
                </div>
              ` : ''}
              <div style="font-size: 24px; margin-top: 25px; font-weight: 900;">
                ğŸ Ø§Ø°Ù‡Ø¨ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©!
              </div>
            </div>
            <button class="reset-btn" id="resetBtn">
              ğŸ”„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
            </button>
          </div>
        `;
      }

      /**
       * Update status badge
       */
      updateStatusBadge(state) {
        const statusMap = {
          'IDLE': { text: 'ğŸŸ¢ Ready', class: 'idle' },
          'PRODUCT_SELECTED': { text: 'ğŸŸ¡ Product Selected', class: 'product-selected' },
          'WAITING_PAYMENT': { text: 'ğŸ”µ Processing', class: 'waiting-payment' },
          'PAYMENT_CONFIRMED': { text: 'ğŸŸ£ Confirmed', class: 'payment-confirmed' },
          'DISPENSING': { text: 'ğŸ”´ Dispensing', class: 'dispensing' },
          'COMPLETE': { text: 'ğŸŸ¢ Complete', class: 'complete' }
        };

        const status = statusMap[state] || statusMap['IDLE'];
        this.statusBadge.textContent = status.text;
        this.statusBadge.className = `status-badge ${status.class}`;
      }
    }

    /**
     * Mobile Context - State Machine Model
     */
    class MobileContext {
      constructor(view, eventBus, machineId) {
        this.view = view;
        this.eventBus = eventBus;
        this.machineId = machineId;
        this.currentState = null;
        this.sessionData = {
          selectedProduct: null,
          amountPaid: 0,
          change: 0
        };

        this.registerEventHandlers();
        this.registerUIHandlers();
        this.transitionTo(new MobileIdleState());
      }

      /**
       * Register event handlers
       */
      registerEventHandlers() {
        const eventTypes = [
          'PRODUCT_SELECTED',
          'MONEY_ADDED',
          'PAYMENT_CONFIRMED',
          'TRANSACTION_COMPLETE',
          'RESET'
        ];

        eventTypes.forEach(eventType => {
          this.eventBus.on(eventType, (event) => {
            if (this.currentState) {
              this.currentState.handleEvent(event, this);
            }
          });
        });
      }

      /**
       * Register UI event handlers (Decoupled via EventBus)
       */
      registerUIHandlers() {
        // Product selection
        document.addEventListener('click', (e) => {
          const productCard = e.target.closest('.product-card');
          if (productCard && this.currentState.name === 'MOBILE_IDLE') {
            const productId = productCard.dataset.productId;
            const product = this.view.products.find(p => p.id === productId);
            
            // Highlight selected product
            document.querySelectorAll('.product-card').forEach(card => {
              card.classList.remove('selected');
            });
            productCard.classList.add('selected');

            // Emit event
            this.eventBus.emit('PRODUCT_SELECTED', { product });

            // Send to Firebase
            this.sendProductSelectionToFirebase(product);
          }
        });

        // Money buttons
        document.addEventListener('click', (e) => {
          const moneyBtn = e.target.closest('.money-btn');
          if (moneyBtn && !moneyBtn.disabled) {
            const amount = parseInt(moneyBtn.dataset.amount);
            this.eventBus.emit('MONEY_ADDED', { amount });
          }
        });

        // Confirm button
        document.addEventListener('click', (e) => {
          if (e.target.id === 'confirmBtn' && !e.target.disabled) {
            this.eventBus.emit('PAYMENT_CONFIRMED', {});
          }
        });

        // Reset button
        document.addEventListener('click', (e) => {
          if (e.target.id === 'resetBtn') {
            this.eventBus.emit('RESET', {});
          }
        });
      }

      /**
       * Transition to new state
       */
      transitionTo(newState) {
        console.log(`[MOBILE_STATE_MACHINE] ${this.currentState?.name || 'null'} â†’ ${newState.name}`);
        
        if (this.currentState) {
          this.currentState.exit(this);
        }

        this.currentState = newState;
        this.currentState.enter(this);
      }

      /**
       * Send product selection to Firebase
       */
      async sendProductSelectionToFirebase(product) {
        if (!window.firebaseDatabase) return;

        try {
          const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
          await window.firebaseSet(sessionRef, {
            state: 'PRODUCT_SELECTED',
            selectedProductId: product.id,
            selectedProductName: product.name,
            selectedProductIcon: product.icon,
            selectedProductPrice: product.price,
            amountPaid: 0,
            change: 0,
            timestamp: Date.now()
          });
        } catch (error) {
          console.error('[FIREBASE] Error:', error);
        }
      }

      /**
       * Send payment to machine
       */
      async sendToMachine() {
        if (!window.firebaseDatabase) return;

        try {
          const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
          await window.firebaseSet(sessionRef, {
            state: 'WAITING_PAYMENT',
            selectedProductId: this.sessionData.selectedProduct.id,
            selectedProductName: this.sessionData.selectedProduct.name,
            selectedProductIcon: this.sessionData.selectedProduct.icon,
            selectedProductPrice: this.sessionData.selectedProduct.price,
            amountPaid: this.sessionData.amountPaid,
            change: this.sessionData.change,
            timestamp: Date.now()
          });

          console.log('[FIREBASE] Payment sent to machine');
        } catch (error) {
          console.error('[FIREBASE] Error:', error);
        }
      }

      /**
       * Reset session
       */
      async resetSession() {
        this.sessionData = {
          selectedProduct: null,
          amountPaid: 0,
          change: 0
        };

        if (!window.firebaseDatabase) return;

        try {
          const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${this.machineId}`);
          await window.firebaseSet(sessionRef, {
            state: 'IDLE',
            selectedProductId: null,
            selectedProductName: null,
            selectedProductIcon: null,
            selectedProductPrice: 0,
            amountPaid: 0,
            change: 0,
            timestamp: Date.now()
          });
        } catch (error) {
          console.error('[FIREBASE] Error:', error);
        }
      }
    }

    // ============================================
    // 4. FIREBASE INITIALIZATION
    // ============================================

    const firebaseConfig = {
      apiKey: "AIzaSyBSaulFhBLOd9KP0BkZXNdh0OFv4GACUPU",
      authDomain: "vending-machine-b7af8.firebaseapp.com",
      databaseURL: "https://vending-machine-b7af8-default-rtdb.firebaseio.com",
      projectId: "vending-machine-b7af8",
      storageBucket: "vending-machine-b7af8.firebasestorage.app",
      messagingSenderId: "242706996040",
      appId: "1:242706996040:web:b88f48fdd5bf5c21929c23"
    };

    const script1 = document.createElement('script');
    script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
    document.head.appendChild(script1);

    const script2 = document.createElement('script');
    script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js';
    document.head.appendChild(script2);

    script2.onload = () => {
      firebase.initializeApp(firebaseConfig);
      window.firebaseDatabase = firebase.database();
      window.firebaseRef = firebase.database().ref.bind(firebase.database());
      window.firebaseSet = (ref, data) => ref.set(data);
      window.firebaseOnValue = (ref, callback) => ref.on('value', callback);

      const urlParams = new URLSearchParams(window.location.search);
      const machineId = urlParams.get('machine') || 'VM-001';
      window.MACHINE_ID = machineId;
      document.getElementById('machineIdDisplay').textContent = `Machine: ${machineId}`;

      const view = new MobileView();
      const eventBus = new MobileEventBus();
      const mobileContext = new MobileContext(view, eventBus, machineId);

      // Listen to Firebase for machine state updates
      const sessionRef = window.firebaseRef(window.firebaseDatabase, `sessions/${machineId}`);
      window.firebaseOnValue(sessionRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        console.log('[FIREBASE] Received:', data);
        view.updateStatusBadge(data.state);

        // Handle complete state from machine
        if (data.state === 'COMPLETE' && mobileContext.currentState.name === 'MOBILE_WAITING') {
          eventBus.emit('TRANSACTION_COMPLETE', {});
        }
      });

      console.log('[MOBILE_SYSTEM] Initialized successfully');
      console.log('[MOBILE_SYSTEM] State Pattern: âœ…');
      console.log('[MOBILE_SYSTEM] Event-Driven: âœ…');
      console.log('[MOBILE_SYSTEM] Model-View Separation: âœ…');
    };

    // Initialize Elements SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: {},
        onConfigChange: async (config) => {},
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map()
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a864882c2865dab',t:'MTc2NDc5ODY2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
